<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Router (bantorra.Bantorra.Router)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.3"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">bantorra</a> &#x00BB; <a href="../index.html">Bantorra</a> &#x00BB; Router</nav><header class="odoc-preamble"><h1>Module <code><span>Bantorra.Router</span></code></h1><p>Routers.</p></header><nav class="odoc-toc"><ul><li><a href="#types">Types</a></li><li><a href="#algebraic-effects">Algebraic Effects</a></li><li><a href="#built-in-routers-and-utility-functions">Built-in Routers and Utility Functions</a><ul><li><a href="#router-combinators">Router Combinators</a></li><li><a href="#base-routers">Base Routers</a></li><li><a href="#configuration-files">Configuration Files</a></li></ul></li></ul></nav><div class="odoc-content"><h2 id="types"><a href="#types" class="anchor"></a>Types</h2><div class="odoc-spec"><div class="spec type anchored" id="type-param"><a href="#type-param" class="anchor"></a><code><span><span class="keyword">type</span> param</span><span> = <a href="../Marshal/index.html#type-value">Marshal.value</a></span></code></div><div class="spec-doc"><p>The type of parameters to routers.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = <span><a href="#type-param">param</a> <span class="arrow">&#45;&gt;</span></span> <a href="../FilePath/index.html#type-t">FilePath.t</a></span></code></div><div class="spec-doc"><p>The type of library routers. A router is a function from JSON parameters to file paths.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-pipe"><a href="#type-pipe" class="anchor"></a><code><span><span class="keyword">type</span> pipe</span><span> = <span><a href="#type-param">param</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-param">param</a></span></code></div><div class="spec-doc"><p>The type of parameter transformers.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-table"><a href="#type-table" class="anchor"></a><code><span><span class="keyword">type</span> table</span><span> = <span><span>(<a href="../Marshal/index.html#type-value">Marshal.value</a>, <a href="../Marshal/index.html#type-value">Marshal.value</a>)</span> <span class="xref-unresolved">Stdlib</span>.Hashtbl.t</span></span></code></div><div class="spec-doc"><p>The type of parameter rewrite tables. The invariant is that the keys should be <a href="../Marshal/index.html#val-normalize" title="Marshal.normalize">normalized</a>.</p></div></div><h2 id="algebraic-effects"><a href="#algebraic-effects" class="anchor"></a>Algebraic Effects</h2><div class="odoc-spec"><div class="spec value anchored" id="val-get_version"><a href="#val-get_version" class="anchor"></a><code><span><span class="keyword">val</span> get_version : <span>unit <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p>Get the format version string used by the library manager.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_starting_dir"><a href="#val-get_starting_dir" class="anchor"></a><code><span><span class="keyword">val</span> get_starting_dir : <span>unit <span class="arrow">&#45;&gt;</span></span> <span><a href="../FilePath/index.html#type-t">FilePath.t</a> option</span></span></code></div><div class="spec-doc"><p>Get the starting directory of the resolution, usually the root of the library mounting the current route. That is, if a library X is mounting library Y, the starting directory is usually the root of X when locating the library Y. That said, an application can explicitly specify the starting directory when locating a library.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-run"><a href="#val-run" class="anchor"></a><code><span><span class="keyword">val</span> run : <span><span class="label">version</span>:string <span class="arrow">&#45;&gt;</span></span> <span><span class="optlabel">?starting_dir</span>:<a href="../FilePath/index.html#type-t">FilePath.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Handle the algebraic effects generated by <a href="#val-get_starting_dir"><code>get_starting_dir</code></a>.</p></div></div><h2 id="built-in-routers-and-utility-functions"><a href="#built-in-routers-and-utility-functions" class="anchor"></a>Built-in Routers and Utility Functions</h2><h3 id="router-combinators"><a href="#router-combinators" class="anchor"></a>Router Combinators</h3><div class="odoc-spec"><div class="spec value anchored" id="val-dispatch"><a href="#val-dispatch" class="anchor"></a><code><span><span class="keyword">val</span> dispatch : <span><span>(<span>string <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> option</span>)</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>dispatch lookup</code> accepts JSON arrays of the form <code>[name, arg]</code> and runs the router <code>lookup name</code> with the JSON parameter <code>arg</code></p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-rewrite"><a href="#val-rewrite" class="anchor"></a><code><span><span class="keyword">val</span> rewrite : 
  <span><span class="optlabel">?mode</span>:<span>[ `TryOnce <span>| `ErrOnMissing</span> <span><span>| `Recursively</span> of int</span> ]</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="#type-param">param</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-param">param</a> option</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <a href="#type-pipe">pipe</a></span></code></div><div class="spec-doc"><p><code>rewrite lookup</code> rewrites the JSON parameter <code>param</code> to <code>param'</code> if <code>lookup param</code> is <code>Some param'</code>. Otherwise, if <code>lookup param</code> is <code>None</code>, the <code>param</code> is returned unchanged.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">mode</span> <p><code>`Recursively t</code> means applying <code>lookup</code> until it returns <code>None</code>, and then the parameter before reaching <code>None</code> is returned. <code>`ErrOnMissing</code> means erring when <code>lookup param</code> is <code>None</code> (instead of returning the original parameter) when <code>lookup param</code> is <code>None</code>.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-fix"><a href="#val-fix" class="anchor"></a><code><span><span class="keyword">val</span> fix : <span><span class="optlabel">?hop_limit</span>:int <span class="arrow">&#45;&gt;</span></span> <span><span>(<span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a>)</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>fix f</code> gives the fixed point of <code>f</code>.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">hop_limit</span> <p>The maximum depth of recursive routing. <code>0</code> means no recursive calls and <code>1</code> means recursion at most once. The default value is <code>255</code>.</p></li></ul></div></div><h3 id="base-routers"><a href="#base-routers" class="anchor"></a>Base Routers</h3><div class="odoc-spec"><div class="spec value anchored" id="val-file"><a href="#val-file" class="anchor"></a><code><span><span class="keyword">val</span> file : <span><span class="optlabel">?relative_to</span>:<a href="../FilePath/index.html#type-t">FilePath.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span class="label">expanding_tilde</span>:bool <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>file</code> accepts a JSON string <code>path</code> and return the <code>path</code> as a file path.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">relative_to</span> <p>The base directory to turn relative paths to absolute paths. Without setting this argument, relative paths will be rejected.</p></li></ul><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">expanding_tilde</span> <p>Whether to expand the tilde prefix in a path. (Recommended in most cases.)</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-git"><a href="#val-git" class="anchor"></a><code><span><span class="keyword">val</span> git : <span><span class="optlabel">?err_on_failed_fetch</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><a href="../FilePath/index.html#type-t">FilePath.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>git ~crate</code> accepts JSON parameters in one of the following formats:</p><pre>{ &quot;url&quot;: &quot;git@github.com:RedPRL/bantorra.git&quot; }</pre><pre>{
  &quot;url&quot;: &quot;git@github.com:RedPRL/bantorra.git&quot;,
  &quot;ref&quot;: &quot;main&quot;
}</pre><pre>{
  &quot;url&quot;: &quot;git@github.com:RedPRL/bantorra.git&quot;,
  &quot;path&quot;: &quot;src/library/&quot;
}</pre><pre>{
  &quot;url&quot;: &quot;git@github.com:RedPRL/bantorra.git&quot;,
  &quot;ref&quot;: &quot;main&quot;,
  &quot;path&quot;: &quot;src/library/&quot;
}</pre><p>The <code>ref</code> field can be a commit hash (object name), a branch name, a tag name, or essentially anything accepted by <code>git fetch</code>. (The older <code>git</code> before year 2015 would not accept commit IDs, but please upgrade it already.) The <code>path</code> field is the relative path pointing to the root of the library. If the <code>path</code> field is missing, then the tool assumes the library is at the root of the repository. If the <code>ref</code> field is missing, then <code>&quot;HEAD&quot;</code> is used, which points to the tip of the default branch in the remote repository.</p><p>Different URLs pointing to the &quot;same&quot; git repository are treated as different repositories. Therefore, <code>git@github.com:RedPRL/bantorra.git</code> and <code>https://github.com/RedPRL/bantorra.git</code> are treated as two distinct git repositories. For the same repository, the commits in use must be identical during the program execution; one can use different branch names or tag names, but they must point to the same commit. The resolution would fail if there is an attempt to use different commits of the same repository.</p></div></div><h3 id="configuration-files"><a href="#configuration-files" class="anchor"></a>Configuration Files</h3><p>Format of the configuration files:</p><pre>{
  &quot;format&quot;: &quot;1.0.0&quot;,
  &quot;rewrite&quot;: [ [&quot;stdlib&quot;, &quot;~/coollib/stdlib&quot;] ]
}</pre><p><code>rewrite</code> is an array of pairs of JSON values. If the property <code>rewrite</code> is missing, it is understood as the empty array. The array will be parsed as a <a href="#type-table" title="table">rewrite table</a>. The table is intended to be used with <a href="#val-rewrite"><code>rewrite</code></a> as follows:</p><pre class="language-ocaml"><code>rewrite (lookup_table (read_table ~version:&quot;1.0.0&quot; &quot;file&quot;))</code></pre><p>Note: the format version string of the configuration files should match that used by the library manager.</p><div class="odoc-spec"><div class="spec value anchored" id="val-lookup_table"><a href="#val-lookup_table" class="anchor"></a><code><span><span class="keyword">val</span> lookup_table : <span><a href="#type-table">table</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-param">param</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-param">param</a> option</span></span></code></div><div class="spec-doc"><p><code>lookup_table table param</code> looks up the (normalized) <code>param</code> in <code>table</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-parse_table"><a href="#val-parse_table" class="anchor"></a><code><span><span class="keyword">val</span> parse_table : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-table">table</a></span></code></div><div class="spec-doc"><p><code>parse_table str</code> parse <code>str</code> as a table.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-read_table"><a href="#val-read_table" class="anchor"></a><code><span><span class="keyword">val</span> read_table : <span><a href="../FilePath/index.html#type-t">FilePath.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-table">table</a></span></code></div><div class="spec-doc"><p><code>read_table path</code> is <code>parse_table ~version (File.read path)</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_web_table"><a href="#val-get_web_table" class="anchor"></a><code><span><span class="keyword">val</span> get_web_table : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-table">table</a></span></code></div><div class="spec-doc"><p><code>get_web_table path</code> is <code>parse_table ~version (Web.get url)</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-write_table"><a href="#val-write_table" class="anchor"></a><code><span><span class="keyword">val</span> write_table : <span><a href="../FilePath/index.html#type-t">FilePath.t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-table">table</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>write_table path table</code> writes table to the file at <code>path</code>.</p></div></div></div></body></html>
